<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@600&display=swap" rel="stylesheet">
<style>  
  body {
    font-family: 'Inter', 'sans serif';
    background-color: #121212;
    color: white;
    font-size: 10px;
  }

  p {
    font-weight: 600;
    color: rgb(200, 200, 200);
  }

  #ui {
    border-left: 1px solid rgba(60, 60, 60);
    position: absolute;
    float: left;
    top: 0;
    right: 0;
    height: 100vh;
    width: 25vw;
    text-align: left;
  }

  /* Menu */
  nav {
    border-bottom: 1px #333 solid;
  }

  ul {
    list-style: none;
    display: flex;
    padding: 0px;
    justify-content: center;
  }

  li {
    padding: 6px 12px;
    cursor: pointer;
    font-weight: 600;
  }

  /* Scene */
  #scene, #settings {
    padding-left: 10px;
  }

  .scrollable-div {
    width: 165px;
    height: 325px;
    overflow: auto;
  }

  .scrollable-div::-webkit-scrollbar {
    width: 10px;
  }

  .scrollable-div::-webkit-scrollbar-thumb {
    background-color: white;
    border-radius: 20px;
  }

  input[type=number]::-webkit-inner-spin-button { 
    -webkit-appearance: none;
    
  }

  input[type=number] { 
    -moz-appearance: textfield;
    appearance: textfield;

  }

  .input {
    display: flex;
    align-items: center;
  }
  
  .input-element {
    border: none;
    outline: none;
    padding: 8px;
    padding-right: 0;
    margin: 0;
    justify-self: stretch;
    min-width: 0;
    border-radius: 2px;
    transition: box-shadow 0.3s ease;
    background-color: rgba(var(--rgbSurface));
    height: 32px;
    width: 30px;
    color: rgba(200, 200, 200);
  }

  .input-range {
    width: 80px;
    margin-right: 10%;
    margin-left: 10%;
    -webkit-appearance: none;
    background: transparent;
    appearance: none;
  }

  .input-range:focus {
    outline: none;
  }

  .input-range::-webkit-slider-runnable-track {
   background-color: #7d7d7d;
   border-radius: 0.5rem;
   height: 0.5rem;  
  }

  .input-range::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    margin-top: -5px;

    /* custom styles */
    background-color: var(--figma-color-text);
    height: 1.2rem;
    width: 1.2rem;
    border-radius: 100%;
  }


  /* Settings */
  input[type=checkbox] {
    position: relative;
    cursor: pointer;
    width: 33px;
    height: 19px;
  }

  input[type=checkbox]::before, input[type=checkbox]::after {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    transition: left .15s cubic-bezier(.25, .8, .25, .1), transform .15s ease-in;
  }

  input[type=checkbox]::before {
    background-color: #ccc;
    width: 100%;
    height: 100%;
    border-radius: 28px;
  }

  input[type=checkbox]::after {
    margin: 2px 0 0 2px;
    background: #fff;
    width: 15px;
    height: 15px;
    border-radius: 100%;
  }

  input[type=checkbox]:checked::before {
    background-color: #18a0fb;
  }

  input[type=checkbox]:checked::after {
    left: 14px;
  }

  label {
    color: #979797;
    font-size: 12px;
  }

  .color {
    appearance: none;
    border: none;
    cursor: pointer;
    background-color: transparent;
    width: 25px;
    height: 25px;
  }

  .color::-webkit-color-swatch {
    border: none;
    border-radius: 3px;
  }  

  .inputColor {
    width: 100%;
    text-align: right;
    padding: 0 10 0 10;
  }

  /* Buttons */
  #float-button {
    position: absolute;
    bottom: 10px;
  }

  button {
    border-radius: 25px;
    padding: 8px 15px;
    margin: 10px 10px;
    color: white;
  }
    
  #apply {
    background-color: #18a0fb;
    border: 1px #18a0fb solid;
    box-shadow: none;
  }
    
  #close {
    background-color: black;
    border: 1px #333 solid;
    box-shadow: inset 0 0 0 1px black;
  }

  /* TheeJS */
  #threeJS {
    position: absolute;
    float: right;
    top: 0;
    left: 0;
  }

</style>

<div>
  <div id="ui">
    <nav id="nav">
      <ul>
        <li id="btn_layers" style="color: #18a0fb;">Layers</li>
        <li id="btn_scene">Scene</li>
        <li id="btn_settings">Settings</li>
      </ul>
    </nav>
    <div id="layers">
      <p>Layers</p>
    </div>
    <div id="scene" class="scrollable-div" style="display: none;">
      <div>
        <p>Positon X</p>
        <div class="input">
          <div class="input_icon">
            <svg width="16" height="16" fill="none"><path stroke="currentColor" d="M5 8c0 3.314 1.343 6 3 6s3-2.686 3-6-1.343-6-3-6C6.89 2 5.92 3.207 5.401 5M5 8l-2 2.5M5 8l2.5 2"></path></svg>
           </div>
          <input type="number" id="input-positionX" value="0" class="input-element" step="0.1">
          <input type="range" min="-15" max="15" value="0" id="range-positionX" class="input-range">
        </div>
      </div>
      <div>
        <p>Position Y</p>
        <div class="input">
          <div class="input_icon">
            <svg width="16" height="16" fill="none"><path stroke="currentColor" d="M5 8c0 3.314 1.343 6 3 6s3-2.686 3-6-1.343-6-3-6C6.89 2 5.92 3.207 5.401 5M5 8l-2 2.5M5 8l2.5 2"></path></svg>
          </div>
          <input type="number" id="input-positionY" value="0" class="input-element" step="0.1">
          <input type="range" min="-15" max="15" value="0" id="range-positionY" class="input-range">
        </div>
      </div>
      <div>
        <p>Position Z</p>
        <div class="input">
          <div class="input_icon">
            <svg width="16" height="16" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M6.17678 2.82322C6.07915 2.72559 5.92085 2.72559 5.82322 2.82322L4.23223 4.41421C4.1346 4.51184 4.1346 4.67014 4.23223 4.76777C4.32986 4.8654 4.48816 4.8654 4.58579 4.76777L6 3.35355L7.41421 4.76777C7.51184 4.8654 7.67014 4.8654 7.76777 4.76777C7.8654 4.67014 7.8654 4.51184 7.76777 4.41421L6.17678 2.82322ZM5.75 3V12H6.25V3H5.75Z" fill="currentColor"></path><path d="M9.82322 12.1768C9.92085 12.2744 10.0791 12.2744 10.1768 12.1768L11.7678 10.5858C11.8654 10.4882 11.8654 10.3299 11.7678 10.2322C11.6701 10.1346 11.5118 10.1346 11.4142 10.2322L10 11.6464L8.58579 10.2322C8.48816 10.1346 8.32986 10.1346 8.23223 10.2322C8.1346 10.3299 8.1346 10.4882 8.23223 10.5858L9.82322 12.1768ZM10.25 12L10.25 3L9.75 3L9.75 12L10.25 12Z" fill="currentColor"></path></svg>
          </div>
          <input type="number" id="input-positionZ" value="0" class="input-element" step="0.1">
          <input type="range" min="-15" max="15" value="0" id="range-positionZ" class="input-range">
        </div>    
      </div>
      <div>
        <p>Rotation X (Graus)</p>
        <div class="input">
          <div class="input_icon">
            <svg width="16" height="16" fill="none"><path stroke="currentColor" d="M5 8c0 3.314 1.343 6 3 6s3-2.686 3-6-1.343-6-3-6C6.89 2 5.92 3.207 5.401 5M5 8l-2 2.5M5 8l2.5 2"></path></svg>
          </div>
          <input type="number" id="input-rotationX" value="0" class="input-element">
          <input type="range" min="-180" max="180" value="0" id="range-rotationX" class="input-range">
        </div>
      </div>
      <div>
        <p>Rotation Y (Graus)</p>
        <div class="input">
          <div class="input_icon">
            <svg width="16" height="16" fill="none"><path stroke="currentColor" d="M5 8c0 3.314 1.343 6 3 6s3-2.686 3-6-1.343-6-3-6C6.89 2 5.92 3.207 5.401 5M5 8l-2 2.5M5 8l2.5 2"></path></svg>
          </div>
          <input type="number" id="input-rotationY" value="0" class="input-element">
          <input type="range" min="-180" max="180" value="0" id="range-rotationY" class="input-range">
        </div>
      </div>
      <div>
        <p>Rotation Z (Graus)</p>
        <div class="input">
          <div class="input_icon">
            <svg width="16" height="16" fill="none"><path stroke="currentColor" d="M5 8c0 3.314 1.343 6 3 6s3-2.686 3-6-1.343-6-3-6C6.89 2 5.92 3.207 5.401 5M5 8l-2 2.5M5 8l2.5 2"></path></svg>
          </div>
          <input type="number" id="input-rotationZ" value="0" class="input-element">
          <input type="range" min="-180" max="180" value="0" id="range-rotationZ" class="input-range">
        </div>
      </div>
      <div>
        <p>Display Component</p>
        <div class="input">
          <div>
            <input type="checkbox" id="visible">
          </div>
        </div>
      </div>
      <div>
        <p>Draggable</p>
        <div class="input">
          <select>
            <option value="1">Anchor</option>
            <option value="2">Draggable</option>
          </select>
        </div>
      </div>
      <div>
        <p>Open</p>
        <div class="input">
          <select>
            <option value="1">New Window</option>
            <option value="2">Overwrite</option>
          </select>
        </div>
      </div>
    </div>
    <div id="settings" style="display: none;">
      <div>
        <p>Show Orbit</p>
        <div class="input">
          <div>
            <input type="checkbox" id="showOrbit" checked>
          </div>
          <div class="inputColor">
            <label>Color: </label>
            <input type="color" id="colorOrbit" value="#ffffff" class="color">
          </div>
        </div>
      </div>
      <div>
        <p>Show 3D User</p>
        <div class="input">
          <div>
            <input type="checkbox" id="showUser" checked>
          </div>
          <div class="inputColor">
            <label>Color: </label>
            <input type="color" id="colorUser" value="#ffffff" class="color">
          </div>
        </div>
      </div>
    </div>
    <div id="float-button">
      <button id="apply">Save</button>
      <button id="close">Close</button>
    </div>
  </div>
  <div id="threeJS"></div>
</div>

<script type="importmap">
  {
    "imports": {
      "three": "https://unpkg.com/three@0.152.2/build/three.module.js"
    }
  }
</script>

<script type="module">
import * as THREE from 'three'
import { OrbitControls } from 'https://threejs.org/examples/jsm/controls/OrbitControls.js'
import { OBJLoader } from 'https://threejs.org/examples/jsm/loaders/OBJLoader.js'
import { GLTFLoader } from 'https://threejs.org/examples/jsm/loaders/GLTFLoader.js'

onmessage = async event => {
  let data = event.data.pluginMessage
  if(!data.isComponent){
    alert('Selecione somente componentes')
    parent.postMessage({ pluginMessage: { type: 'close' } }, '*')
  }

  // Obtenha a largura e altura da tela
  const screenWidth = 520
  const screenHeight = 450

  // Renderer
  const renderer = new THREE.WebGLRenderer()
  renderer.setSize(screenWidth, screenHeight)
  renderer.outputColorSpace = THREE.SRGBColorSpace;
  document.querySelector('#threeJS').appendChild(renderer.domElement)

  // Scene
  const scene = new THREE.Scene()
  scene.background = new THREE.Color(0x121212) 
  
  new GLTFLoader().load(
    'https://raw.githubusercontent.com/ruxailab/figma-vr-unity-converter/fix/environment/FTU_FigmaToUnity/assets/vr-store/scene.gltf',
    gltf  => gltf.scene.traverse(child => {
      if (child.isMesh) scene.add(child)
    }),
    xhr => console.log( xhr.loaded / xhr.total + '%'),
    error => console.log(error)
  )

  // new OBJLoader().load(
  //   'https://raw.githubusercontent.com/ruxailab/figma-vr-unity-converter/fix/environment/FTU_FigmaToUnity/trail.obj',
  //   object => {
  //     scene.add(object)
  //   },
  //   xhr => console.log( xhr.loaded / xhr.total + '%'),
  //   error => {}
  // )
  // const sphereGeometry = new THREE.SphereGeometry(15, 64, 40)
  // sphereGeometry.scale(-1, 1, 1)
  // const sphereMaterial = new THREE.MeshBasicMaterial({
  //   map: new THREE.TextureLoader().load('https://media.discordapp.net/attachments/1073959819507150899/1205242675113230406/render-360_1.jpg?ex=65d7a8b6&is=65c533b6&hm=e5faf94764068492a0433bf0af915232c8421de7a16838c7142bad9d24c78f5c&=&format=webp&width=994&height=497')
  // })
  // const sphereMesh = new THREE.Mesh(sphereGeometry, sphereMaterial)
  // console.log(sphereMesh)
  // sphereMesh.position.y = 10
  // scene.add(sphereMesh)

  // const textureArray = []
  // const textureFront = new THREE.TextureLoader().load('https://media.discordapp.net/attachments/1126517490449666088/1205236093553737808/front.jpg?ex=65d7a294&is=65c52d94&hm=0c3055d67c25212d5862a0e5d0d277cc4bde323ecb2071c9c0a02864a4ca03fe&=&format=webp&width=497&height=497')
  // const textureBack = new THREE.TextureLoader().load('https://media.discordapp.net/attachments/1126517490449666088/1205236094329819226/back.jpg?ex=65d7a295&is=65c52d95&hm=9e342a852c83d2f37f95a5dce330d3b874650709cec7d221e0568bfb3dd207e3&=&format=webp&width=497&height=497')
  // const textureTop = new THREE.TextureLoader().load('https://media.discordapp.net/attachments/1126517490449666088/1205236092383789127/top.jpg?ex=65d7a294&is=65c52d94&hm=d17bc8afcedf27b0ae0624f7606bd25a7c7025580ccc5d5ee60de22a36966672&=&format=webp&width=497&height=497')
  // const textureBottom = new THREE.TextureLoader().load('https://media.discordapp.net/attachments/1126517490449666088/1205236093990076537/bottom.jpg?ex=65d7a295&is=65c52d95&hm=f4bc3e26b783d14c43b2c9b8be1ba8bd9b8b2db80193033bb9b09f39882e59e1&=&format=webp&width=497&height=497')
  // const textureLeft = new THREE.TextureLoader().load('https://media.discordapp.net/attachments/1126517490449666088/1205236093189103697/left.jpg?ex=65d7a294&is=65c52d94&hm=511f4d3adb89eb6628d0b8c83f2e7495256a5a4911c022111d2172eb1e6688ce&=&format=webp&width=497&height=497')
  // const textureRight = new THREE.TextureLoader().load('https://media.discordapp.net/attachments/1126517490449666088/1205236092857749564/right.jpg?ex=65d7a294&is=65c52d94&hm=7397990306d46b14eeef57d1e17c0e086ab856e31ac1eb0aeffe31e3b303784a&=&format=webp&width=497&height=497')

  // textureArray.push(new THREE.MeshBasicMaterial({ map: textureFront }))
  // textureArray.push(new THREE.MeshBasicMaterial({ map: textureBack }))
  // textureArray.push(new THREE.MeshBasicMaterial({ map: textureTop }))
  // textureArray.push(new THREE.MeshBasicMaterial({ map: textureBottom }))
  // textureArray.push(new THREE.MeshBasicMaterial({ map: textureLeft }))
  // textureArray.push(new THREE.MeshBasicMaterial({ map: textureRight }))

  // const geometry = new THREE.BoxGeometry(20, 20, 20);
  // geometry.scale(-1, 1, 1)
  // const cubeMaterial = new THREE.MeshBasicMaterial({ color: 0xffffff})
  // const cube = new THREE.Mesh(geometry, textureArray)
  // console.log(cube)
  // cube.position.y = 5
  // scene.add(cube)

  // Camera
  const fov = 45
  const aspect = screenWidth / screenHeight
  const near = 0.1
  const far = 1000
  const camera = new THREE.PerspectiveCamera(fov, aspect, near, far)
  const controls = new OrbitControls(camera, renderer.domElement)
  camera.position.set(0, 0, 5)

  // Light
  const ambientLight = new THREE.AmbientLight(0xffffff, 0.8)
  scene.add(ambientLight)
  
  // Human
  let human
  const urlHuman = 'https://raw.githubusercontent.com/ruxailab/figma-vr-unity-converter/fix/environment/FTU_FigmaToUnity/assets/human.obj'
  new OBJLoader().load(
    urlHuman,
    object => {
      human = object
      human.rotation.y = mapEuler(180)
      human.position.y = -1
      human.scale.x = 0.2
      human.scale.y = 0.2
      human.scale.z = 0.2
      human.children[0].material.emissive = new THREE.Color('#ffffff')
      scene.add(human)
    },
    xhr => {},
    error => {}
  )

  // Circle
  const radius = 10
  const sectors = 16
  const rings = 8
  const divisions = 64
  const circle = new THREE.PolarGridHelper(radius, sectors, rings, divisions)
  circle.position.y = -1
  scene.add(circle)

  // Component
  const meshComponents = await Promise.all(
    data.components.map(component => new Promise(resolve => {
      const width = component.width / 2
      const height = component.height / 2

      const geometryComponent = new THREE.BoxGeometry(width, height, 0.001)
      const imageBlob = new Blob([component.image], {type: 'image/png'})
      const url = URL.createObjectURL(imageBlob)
      new THREE.TextureLoader().load(url, texture =>{        
        const materialComponent = new THREE.MeshStandardMaterial({ map: texture, transparent: true })
        materialComponent.needsUpdate = true
        materialComponent.map.encoding = THREE.sRGBEncoding

        const meshComponent = new THREE.Mesh(geometryComponent, materialComponent)
        const { positionX, positionY, positionZ, rotationX, rotationY, rotationZ, visible } = component.property
        meshComponent.position.set(positionX, positionY, positionZ)
        meshComponent.rotation.set(mapEuler(rotationX), mapEuler(rotationY), mapEuler(rotationZ))
        meshComponent.componentVisible = visible
        meshComponent.material.color.setRGB(visible ? 1 : 0.2, visible ? 1 : 0.2, visible ? 1 : 0.2)
        scene.add(meshComponent)
        resolve(meshComponent)
      })
    }))
  )

  // Click Object
  const pointer = new THREE.Vector2()
  const raycaster = new THREE.Raycaster()
  let select, line

  document.querySelector('#threeJS').addEventListener('click', event => {
    pointer.x = (event.clientX / window.innerWidth) * 2 - 0.7
    pointer.y = -(event.clientY / window.innerHeight) * 2 + 1
    raycaster.setFromCamera(pointer, camera)
    const intersects = raycaster.intersectObjects(meshComponents)  

    if (intersects.length <= 0) {
      scene.remove(line)
      document.querySelector('#btn_layers').style.color = '#18a0fb'
      document.querySelector('#btn_scene').style.color = '#ffffff'
      document.querySelector('#btn_settings').style.color = '#ffffff'
      document.querySelector('#layers').style.display = 'block'
      document.querySelector('#scene').style.display = 'none'  
      document.querySelector('#settings').style.display = 'none'
      return select = undefined
    }
      
    if(select) scene.remove(line)
    select = intersects[0].object
    let parameters = select.geometry.parameters

    document.querySelector('#btn_layers').style.color = '#ffffff'
    document.querySelector('#btn_scene').style.color = '#18a0fb'
    document.querySelector('#btn_settings').style.color = '#ffffff'
    document.querySelector('#layers').style.display = 'none'
    document.querySelector('#scene').style.display = 'block'  
    document.querySelector('#settings').style.display = 'none'

    const { width, height } = select.geometry.parameters
    const geometry = new THREE.BoxGeometry(width, height, 0.5)
    const edges = new THREE.EdgesGeometry(geometry)
    const lineMaterial = new THREE.LineDashedMaterial({ color: 0x5100ff, linewidth: 20, scale: 20 })
    line = new THREE.LineSegments(edges, lineMaterial)

    const { position, rotation } = select
    document.querySelector('#input-positionX').value = position.x
    document.querySelector('#input-positionY').value = position.y
    document.querySelector('#input-positionZ').value = -position.z
    document.querySelector('#input-rotationX').value = mapRadianos(rotation.x)
    document.querySelector('#input-rotationY').value = mapRadianos(rotation.y)
    document.querySelector('#input-rotationZ').value = mapRadianos(rotation.z)
    document.querySelector('#visible').checked = select.componentVisible
    scene.add(line)
  })

  // Animation
  const animate = () => {
    requestAnimationFrame(animate)
    controls.update()

    if(select) {
      const { position, rotation } = select
      const { checked } = document.querySelector('#visible')

      position.x = document.querySelector('#input-positionX').value
      position.y = document.querySelector('#input-positionY').value
      position.z = -document.querySelector('#input-positionZ').value
      rotation.x = mapEuler(document.querySelector('#input-rotationX').value)
      rotation.y = mapEuler(document.querySelector('#input-rotationY').value)
      rotation.z = mapEuler(document.querySelector('#input-rotationZ').value)

      select.componentVisible = checked
      select.material.color.setRGB(checked ? 1 : 0.2, checked ? 1 : 0.2, checked ? 1 : 0.2)

      line.position.copy(position)
      line.rotation.copy(rotation)
    }
    renderer.render(scene, camera)
  }
  animate()

  // Buttons
  document.querySelector('#apply').onclick = () => {
    const components = meshComponents.map(meshComponent => ({
      positionX: meshComponent.position.x || 0,
      positionY: meshComponent.position.y || 0,
      positionZ: meshComponent.position.z || 0,
      rotationX: mapRadianos(meshComponent.rotation._x || 0),
      rotationY: mapRadianos(meshComponent.rotation._y || 0),
      rotationZ: mapRadianos(meshComponent.rotation._z || 0),
      visible: meshComponent.componentVisible,
    }))

    parent.postMessage({ pluginMessage: { type: 'apply', components: components } }, '*')
  }

  document.querySelector('#close').onclick = () => {
    parent.postMessage({ pluginMessage: { type: 'close' } }, '*')
  }

  document.querySelector('#btn_layers').addEventListener('click', () => {
    document.querySelector('#btn_layers').style.color = '#18a0fb'
    document.querySelector('#btn_scene').style.color = '#ffffff'
    document.querySelector('#btn_settings').style.color = '#ffffff'
    document.querySelector('#layers').style.display = 'block'
    document.querySelector('#scene').style.display = 'none'  
    document.querySelector('#settings').style.display = 'none'
  })

  document.querySelector('#btn_scene').addEventListener('click', () => {
    document.querySelector('#btn_layers').style.color = '#ffffff'
    document.querySelector('#btn_scene').style.color = '#18a0fb'
    document.querySelector('#btn_settings').style.color = '#ffffff'
    document.querySelector('#layers').style.display = 'none'
    document.querySelector('#scene').style.display = 'block'  
    document.querySelector('#settings').style.display = 'none'
  })

  document.querySelector('#btn_settings').addEventListener('click', () => {
    document.querySelector('#btn_layers').style.color = '#ffffff'
    document.querySelector('#btn_scene').style.color = '#ffffff'
    document.querySelector('#btn_settings').style.color = '#18a0fb'
    document.querySelector('#layers').style.display = 'none'
    document.querySelector('#scene').style.display = 'none'  
    document.querySelector('#settings').style.display = 'block'
  })

  document.querySelector('#showOrbit').addEventListener('click', () => {
    if(document.querySelector('#showOrbit').checked) return scene.add(circle)
    scene.remove(circle)
  })

  document.querySelector('#colorOrbit').addEventListener('change', () => {
    circle.material.color = new THREE.Color(document.querySelector('#colorOrbit').value)
  })

  document.querySelector('#showUser').addEventListener('click', () => {
    if(document.querySelector('#showUser').checked) return scene.add(human)
    scene.remove(human)
  })

  document.querySelector('#colorUser').addEventListener('change', () => {
    human.children[0].material.emissive = new THREE.Color(document.querySelector('#colorUser').value)
  })
}

// Mapeando Intervalos
const mapEuler = x => (x - 0) * (Math.PI * 2 - 0) / (360 - 0) + 0
const mapRadianos = x => (x - 0) * (360 - 0) / (Math.PI * 2 - 0) + 0
</script>